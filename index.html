<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Central de Agendamentos Andra</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- PALETA DE CORES ANDRA --- */
        :root {
            --cor-primaria: #c71d23; /* Vermelho Andra */
            --cor-primaria-hover: #a5171d;
            --cor-secundaria: #1f2937; /* Preto/Cinza escuro */
            --cor-verde: #10b981;
            --cor-vermelho: #ef4444;
            --cor-fundo: #f8fafc;
            --cor-principal: #ffffff;
            --cor-borda: #e2e8f0;
            --cor-texto: #334155;
            --cor-texto-claro: #64748b;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--cor-fundo);
            margin: 0;
            color: var(--cor-texto);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            box-sizing: border-box;
        }

        /* --- TELA DE SELE√á√ÉO (ESTILO BUSCA/SPOTLIGHT) --- */
        #selector-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d0506 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
            box-sizing: border-box;
        }

        .search-container {
            background: white;
            width: 100%;
            max-width: 480px;
            border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            animation: fadeUp 0.6s ease-out;
            display: flex;
            flex-direction: column;
            max-height: 80vh;
        }

        .search-header {
            padding: 2rem 2rem 1rem 2rem;
            background: white;
            border-bottom: 1px solid var(--cor-borda);
        }

        .search-header h1 {
            font-size: 1.6rem;
            color: var(--cor-secundaria);
            margin: 0 0 0.5rem 0;
            font-weight: 700;
        }
        .search-header h1 span { color: var(--cor-primaria); }
        
        .search-header p {
            margin: 0;
            color: var(--cor-texto-claro);
            font-size: 0.95rem;
        }

        .input-wrapper {
            position: relative;
            margin-top: 1.5rem;
        }
        
        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--cor-texto-claro);
            pointer-events: none;
        }

        #branch-search-input {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            font-size: 1rem;
            border: 2px solid var(--cor-borda);
            border-radius: 0.5rem;
            outline: none;
            transition: all 0.2s;
            background-color: #f8fafc;
            box-sizing: border-box;
            font-family: inherit;
        }
        #branch-search-input:focus {
            border-color: var(--cor-primaria);
            background-color: white;
            box-shadow: 0 0 0 3px rgba(199, 29, 35, 0.1);
        }

        #branch-list-scroll {
            overflow-y: auto;
            padding: 0.5rem;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 transparent;
        }
        #branch-list-scroll::-webkit-scrollbar { width: 6px; }
        #branch-list-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }

        .branch-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            margin-bottom: 4px;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .branch-item:hover {
            background-color: #fff1f2;
            border-color: #fecaca;
        }

        .branch-item-icon {
            width: 36px; height: 36px;
            background-color: #f1f5f9;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            color: var(--cor-texto-claro);
            transition: all 0.2s;
        }
        .branch-item:hover .branch-item-icon {
            background-color: var(--cor-primaria);
            color: white;
        }

        .branch-info { flex: 1; }
        .branch-name { font-weight: 600; color: var(--cor-secundaria); display: block; }
        
        .branch-arrow { color: var(--cor-texto-claro); opacity: 0.5; transition: all 0.2s; }
        .branch-item:hover .branch-arrow { color: var(--cor-primaria); opacity: 1; transform: translateX(2px); }

        /* --- LAYOUT PRINCIPAL --- */
        header { text-align: center; margin-bottom: 3rem; border-bottom: 1px solid var(--cor-borda); padding-bottom: 2rem;}
        
        .header-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .main-header-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--cor-secundaria);
            margin-bottom: 0.5rem;
            letter-spacing: -0.5px;
        }

        /* --- CARDS DE SALAS --- */
        #rooms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            animation: fadeUp 0.5s ease-out;
        }
        
        .room-card {
            background-color: var(--cor-principal);
            border: 1px solid var(--cor-borda);
            border-radius: 1rem;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
        }

        .room-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px -10px rgba(0, 0, 0, 0.1);
            border-color: var(--cor-primaria);
        }

        .room-card.available { border-top: 4px solid var(--cor-verde); }
        .room-card.occupied { border-top: 4px solid var(--cor-primaria); }

        .room-status-badge {
            margin-bottom: 1rem;
            font-size: 0.75rem;
            font-weight: 700;
            padding: 0.25rem 0.75rem;
            border-radius: 2rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-livre { background-color: #ecfdf5; color: #047857; }
        .status-ocupada { background-color: #fff1f2; color: var(--cor-primaria); }

        .room-name {
            font-size: 1.3rem;
            font-weight: 700;
            margin: 0.5rem 0;
            color: var(--cor-secundaria);
        }

        .room-capacity {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            color: var(--cor-texto-claro);
            font-weight: 500;
        }
        .room-capacity svg { width: 18px; height: 18px; opacity: 0.7; }

        .meeting-info {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: #fff1f2;
            border-radius: 0.5rem;
            width: 100%;
            box-sizing: border-box;
            border-left: 3px solid var(--cor-primaria);
        }
        .meeting-title { font-weight: 600; font-size: 0.95rem; color: var(--cor-primaria); display: block; margin-bottom: 4px;}
        .meeting-user { font-size: 0.85rem; color: var(--cor-texto); }

        /* --- MODAIS --- */
        .modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background-color: var(--cor-principal); padding: 2.5rem; border-radius: 1.2rem; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); width: 90%; max-width: 850px; animation: fadeInScale 0.3s ease-out; max-height: 90vh; overflow-y: auto; }
        
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; margin-bottom: 2rem; border-bottom: 2px solid #f1f5f9;}
        .modal-title { font-size: 1.5rem; font-weight: 700; color: var(--cor-secundaria); margin: 0;}
        .close-button { background: none; border: none; font-size: 2.2rem; cursor: pointer; color: #94a3b8; transition: color 0.2s; padding: 0; line-height: 1;}
        .close-button:hover { color: var(--cor-primaria); }
        
        #modal-views { display: flex; gap: 3rem; flex-wrap: wrap; }
        #calendar-view { flex: 1; min-width: 300px; border-right: 1px solid var(--cor-borda); padding-right: 2rem; }
        #schedule-view { flex: 1.2; min-width: 320px; }
        @media (max-width: 768px) { #calendar-view { border-right: none; padding-right: 0; border-bottom: 1px solid var(--cor-borda); padding-bottom: 2rem; }}

        /* CALEND√ÅRIO (CORRIGIDO) */
        .calendar-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .calendar-nav button { background: white; border: 1px solid var(--cor-borda); border-radius: 0.5rem; width: 36px; height: 36px; cursor: pointer; color: var(--cor-texto); transition: all 0.2s; display: flex; align-items: center; justify-content: center; font-weight: bold;}
        .calendar-nav button:hover { border-color: var(--cor-primaria); color: var(--cor-primaria); background: #fff1f2;}
        #month-display { font-weight: 600; color: var(--cor-secundaria); margin: 0; font-size: 1.1rem;}
        
        #calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; text-align: center; }
        .calendar-header { font-weight: 600; font-size: 0.9rem; color: var(--cor-texto-claro); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px;}
        
        /* Corre√ß√£o de Contraste aqui */
        .day { padding: 0.6rem; cursor: pointer; border-radius: 0.5rem; font-weight: 500; transition: all 0.2s; border: 2px solid transparent; }
        .day:hover:not(.empty) { background-color: #f1f5f9; color: var(--cor-primaria); }
        .day.today { border: 2px solid var(--cor-primaria); color: var(--cor-primaria); font-weight: 700; }
        /* O !important garante que o texto fique branco mesmo se for o dia de hoje */
        .day.selected { background-color: var(--cor-primaria); color: white !important; box-shadow: 0 4px 6px rgba(199, 29, 35, 0.3); border-color: var(--cor-primaria); }

        /* HOR√ÅRIOS */
        #schedule-title { color: var(--cor-secundaria); font-weight: 700; margin-top: 0; margin-bottom: 1.5rem;}
        .time-slot { border: 1px solid var(--cor-borda); border-radius: 0.8rem; padding: 1.2rem; margin-bottom: 1rem; background: white; transition: border-color 0.2s;}
        .time-slot:hover { border-color: #cbd5e1; }
        .time-slot-header { display: flex; justify-content: space-between; align-items: center; }
        .time-slot-time { font-weight: 600; font-size: 1.1rem; color: var(--cor-secundaria); }

        .btn { padding: 0.7rem 1.5rem; border: none; border-radius: 0.6rem; cursor: pointer; font-weight: 600; transition: all 0.2s; font-family: inherit; font-size: 0.95rem;}
        .btn-primary { background-color: var(--cor-primaria); color: white; box-shadow: 0 4px 6px rgba(199, 29, 35, 0.2); }
        .btn-primary:hover { background-color: var(--cor-primaria-hover); transform: translateY(-2px); box-shadow: 0 6px 8px rgba(199, 29, 35, 0.3); }
        .btn-secondary { background-color: white; border: 2px solid var(--cor-borda); color: var(--cor-texto); }
        .btn-secondary:hover { border-color: var(--cor-texto-claro); background-color: #f8fafc; }
        .btn-danger { background-color: white; color: var(--cor-vermelho); border: 2px solid rgba(239, 68, 68, 0.3); }
        .btn-danger:hover { background-color: #fef2f2; border-color: var(--cor-vermelho); }
        
        .booking-form { display: none; flex-direction: column; gap: 1rem; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--cor-borda); animation: fadeDown 0.3s ease-out; }
        .form-input { padding: 0.8rem 1rem; border: 2px solid var(--cor-borda); border-radius: 0.6rem; width: 100%; box-sizing: border-box; font-family: inherit; transition: border-color 0.2s; outline: none;}
        .form-input:focus { border-color: var(--cor-primaria); }
        .form-actions { display: flex; justify-content: flex-end; gap: 0.8rem; margin-top: 0.5rem;}

        /* Admin List */
        .admin-booking-item { border: 1px solid var(--cor-borda); padding: 1.2rem; margin-bottom: 1rem; border-radius: 0.8rem; display: flex; justify-content: space-between; align-items: center; background: white;}
        .admin-booking-info strong { color: var(--cor-secundaria); font-size: 1.1rem; }
        .admin-booking-details { color: var(--cor-texto-claro); margin-top: 4px; }

        /* Toasts e Anima√ß√µes */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 1rem 1.5rem; color: white; border-radius: 0.8rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); opacity: 0; animation: slideIn 0.3s forwards; font-weight: 500; display: flex; align-items: center;}
        .toast.success { background-color: var(--cor-verde); }
        .toast.error { background-color: var(--cor-primaria); }
        
        @keyframes slideIn { to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.98) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }

    </style>
</head>
<body>

    <div id="selector-screen">
        <div class="search-container">
            <div class="search-header">
                <h1>Central de Reuni√µes <span>Andra</span></h1>
                <p>Selecione sua unidade para gerenciar salas.</p>
                
                <div class="input-wrapper">
                    <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    <input type="text" id="branch-search-input" placeholder="Buscar unidade (ex: Centro, Filial 23...)" autocomplete="off">
                </div>
            </div>

            <div id="branch-list-scroll">
                <p style="text-align: center; color: #94a3b8; padding: 2rem;">Carregando unidades...</p>
            </div>
        </div>
    </div>

    <div class="container" id="main-app" style="display: none;">
        <header>
            <h1 class="main-header-title" id="branch-title">Carregando...</h1>
            <p style="color: var(--cor-texto-claro); font-size: 1.1rem;">Verifique a disponibilidade e agende sua reuni√£o.</p>
            <div class="header-buttons">
                <button id="change-branch-btn" class="btn btn-secondary" style="display: flex; align-items: center; gap: 8px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                    Trocar Unidade
                </button>
                <button id="general-calendar-btn" class="btn btn-secondary">Ver Agenda do Dia</button>
                <button id="admin-cancel-btn" class="btn btn-danger">Painel do Administrador</button>
            </div>
        </header>

        <main>
            <div id="rooms-grid"></div>
        </main>
    </div>

    <div id="booking-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <span style="font-size: 0.9rem; color: var(--cor-texto-claro); text-transform: uppercase; letter-spacing: 1px; font-weight: 600;">Agendar Sala</span>
                    <h2 id="modal-room-name" class="modal-title"></h2>
                </div>
                <button class="close-button" data-target="#booking-modal">&times;</button>
            </div>
            <div id="modal-views">
                <div id="calendar-view">
                    <div class="calendar-nav">
                        <button id="prev-month-btn">&lt;</button>
                        <h3 id="month-display">M√™s</h3>
                        <button id="next-month-btn">&gt;</button>
                    </div>
                    <div id="calendar"></div>
                </div>
                <div id="schedule-view">
                    <h3 id="schedule-title">Selecione um dia</h3>
                    <div id="time-slots"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="general-calendar-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Agenda Completa do Dia</h2>
                <button class="close-button" data-target="#general-calendar-modal">&times;</button>
            </div>
            <div id="general-schedule-list"></div>
        </div>
    </div>

    <div id="password-modal" class="modal">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <div class="modal-header" style="justify-content: center; border-bottom: none; padding-bottom: 0;">
                <h2 class="modal-title">Acesso Administrativo</h2>
            </div>
            <p style="color: var(--cor-texto-claro); margin-bottom: 2rem;">Insira a senha para gerenciar agendamentos.</p>
            <input type="password" id="admin-password-input" class="form-input" placeholder="Senha de acesso" style="text-align: center; font-size: 1.2rem;">
            <button id="password-submit-btn" class="btn btn-primary" style="width: 100%; margin-top: 1.5rem; padding: 1rem;">Acessar Painel</button>
             <button class="btn btn-secondary close-button-alt" data-target="#password-modal" style="width: 100%; margin-top: 0.8rem; border: none;">Cancelar</button>
        </div>
    </div>
    
    <div id="admin-cancel-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Painel de Cancelamento</h2>
                <button class="close-button" data-target="#admin-cancel-modal">&times;</button>
            </div>
            <p style="color: var(--cor-texto-claro); margin-bottom: 1.5rem;">Visualizando agendamentos futuros desta unidade.</p>
            <div id="admin-cancel-list"></div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, onSnapshot, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
             apiKey: "AIzaSyDJ88HxIIoH06xxhzs2XApjQhEb1U9HiqE",
             authDomain: "agendamento-d2404.firebaseapp.com",
             projectId: "agendamento-d2404",
             storageBucket: "agendamento-d2404.appspot.com",
             messagingSenderId: "1001640793820",
             appId: "1:1001640793820:web:362d735d9bd69a8e17c619"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let currentBranchId = null;
        let roomsData = {};
        let unsubscribeRooms = null;
        let selectedRoomId = null;
        let selectedDate = new Date();
        const userIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>`;
        
        // --- NOVO SISTEMA DE BUSCA DE FILIAIS ---
        async function loadBranches() {
            const listContainer = document.getElementById('branch-list-scroll');
            const searchInput = document.getElementById('branch-search-input');
            let allBranches = [];

            try {
                const querySnapshot = await getDocs(collection(db, "filiais"));
                
                if(querySnapshot.empty){
                     listContainer.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 2rem;">Nenhuma unidade encontrada.</p>';
                     return;
                }

                // 1. Guarda dados na mem√≥ria
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    allBranches.push({
                        id: doc.id,
                        name: data.nome || `Filial ${doc.id}`,
                        searchText: (data.nome || `Filial ${doc.id}`).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                    });
                });

                allBranches.sort((a, b) => a.name.localeCompare(b.name));

                // 2. Fun√ß√£o de Renderiza√ß√£o
                function renderList(items) {
                    listContainer.innerHTML = '';
                    if (items.length === 0) {
                        listContainer.innerHTML = '<div style="text-align:center; padding: 2rem; color: #94a3b8;">Nenhuma unidade encontrada.</div>';
                        return;
                    }
                    items.forEach(branch => {
                        const item = document.createElement("div");
                        item.className = "branch-item";
                        item.innerHTML = `
                            <div class="branch-item-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 21h18v-8a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v8z"></path><path d="M9 10a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2"></path><path d="M12 2v4"></path><path d="M2 10a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2"></path></svg>
                            </div>
                            <div class="branch-info"><span class="branch-name">${branch.name}</span></div>
                            <div class="branch-arrow"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
                        `;
                        item.onclick = () => enterBranch(branch.id, branch.name);
                        listContainer.appendChild(item);
                    });
                }

                // 3. Renderiza inicial e ativa filtro
                renderList(allBranches);
                searchInput.addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    const filtered = allBranches.filter(b => b.searchText.includes(term));
                    renderList(filtered);
                });
                searchInput.focus();

            } catch (error) {
                console.error("Erro:", error);
                listContainer.innerHTML = '<p style="text-align: center; color: #ef4444; padding: 2rem;">Erro ao carregar.</p>';
            }
        }

        document.getElementById('change-branch-btn').addEventListener('click', () => {
            document.getElementById('main-app').style.display = 'none';
            document.getElementById('selector-screen').style.display = 'flex';
            if (unsubscribeRooms) unsubscribeRooms();
            roomsData = {};
            // Limpa busca e foca novamente
            const input = document.getElementById('branch-search-input');
            input.value = "";
            input.dispatchEvent(new Event('input'));
            input.focus();
        });

        function enterBranch(branchId, branchName) {
            currentBranchId = branchId;
            const selectorScreen = document.getElementById('selector-screen');
            selectorScreen.style.opacity = '0';
            selectorScreen.style.transition = 'opacity 0.3s ease';

            setTimeout(() => {
                selectorScreen.style.display = 'none';
                selectorScreen.style.opacity = '1';
                document.getElementById('main-app').style.display = 'block';
                document.getElementById('branch-title').textContent = branchName;
                listenToRooms(branchId);
            }, 300);
        }

        function listenToRooms(branchId) {
            const roomsGrid = document.getElementById('rooms-grid');
            roomsGrid.innerHTML = '<p style="text-align:center; width:100%; color: var(--cor-texto-claro);">Sincronizando salas...</p>';
            
            const roomsCollectionRef = collection(db, "filiais", branchId, "rooms");
            
            unsubscribeRooms = onSnapshot(roomsCollectionRef, (snapshot) => {
                roomsData = {};
                roomsGrid.innerHTML = '';
                
                if (snapshot.empty) {
                    roomsGrid.innerHTML = '<div style="grid-column: 1/-1; text-align:center; padding: 3rem; background: white; border-radius: 1rem; border: 1px dashed var(--cor-borda); color: var(--cor-texto-claro);">Nenhuma sala cadastrada nesta unidade ainda.</div>';
                    return;
                }

                snapshot.forEach((doc) => {
                    roomsData[doc.id] = doc.data();
                    createRoomCard(doc.id, doc.data());
                });
                
                if (document.getElementById('booking-modal').style.display === 'flex' && selectedRoomId) {
                    loadScheduleForDate(selectedDate);
                }
            });
        }

        function createRoomCard(id, room) {
            const grid = document.getElementById('rooms-grid');
            const now = new Date();
            const todayKey = formatDateKey(now);
            const currentHour = now.getHours();
            
            const bookingsToday = room.bookings?.[todayKey] || [];
            const currentBooking = bookingsToday.find(b => b.hour === currentHour && b.hour < 18);
            const isOccupied = !!currentBooking;
            
            const card = document.createElement('div');
            card.className = `room-card ${isOccupied ? 'occupied' : 'available'}`;
            card.onclick = () => openBookingModal(id);
            
            let html = `
                <div class="room-status-badge ${isOccupied ? 'status-ocupada' : 'status-livre'}">
                    ${isOccupied ? 'Ocupada agora' : 'Dispon√≠vel'}
                </div>
                <div class="room-name">${room.name}</div>
                <div class="room-capacity">${userIconSVG} At√© ${room.capacity || '?'} pessoas</div>
            `;
            
            if (isOccupied) {
                html += `
                    <div class="meeting-info">
                        <span class="meeting-title">${currentBooking.title}</span>
                        <span class="meeting-user">Respons√°vel: ${currentBooking.user}</span>
                    </div>
                `;
            } else {
                 html += `<div style="margin-top:1.5rem; color:var(--cor-verde); font-weight: 600; font-size:0.95rem; display: flex; align-items: center; gap: 5px;">
                 <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"></path><path d="M12 5l7 7-7 7"></path></svg>
                 Toque para agendar</div>`;
            }
            card.innerHTML = html;
            grid.appendChild(card);
        }

        function formatDateKey(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icon = type === 'success' 
                ? '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>' 
                : '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>';
            toast.innerHTML = icon + message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        window.openBookingModal = function(roomId) {
            selectedRoomId = roomId;
            const room = roomsData[roomId];
            document.getElementById('modal-room-name').textContent = room.name;
            document.getElementById('booking-modal').style.display = 'flex';
            loadCalendar();
            clearSchedule();
        };

        function loadCalendar() {
            const calendarEl = document.getElementById('calendar');
            const monthDisplayEl = document.getElementById('month-display');
            calendarEl.innerHTML = "";
            
            const navDate = new Date(selectedDate);
            navDate.setDate(1);
            
            monthDisplayEl.textContent = navDate.toLocaleDateString("pt-BR", { month: "long", year: "numeric" });
            
            const daysInMonth = new Date(navDate.getFullYear(), navDate.getMonth() + 1, 0).getDate();
            const firstDayIndex = navDate.getDay();
            
            ["D","S","T","Q","Q","S","S"].forEach(d => {
                const el = document.createElement("div");
                el.className = "calendar-header";
                el.innerText = d;
                calendarEl.appendChild(el);
            });
            
            for(let i=0; i<firstDayIndex; i++) calendarEl.appendChild(document.createElement("div"));
            
            const today = new Date();
            for(let i=1; i<=daysInMonth; i++) {
                const dayEl = document.createElement("div");
                dayEl.className = "day";
                dayEl.textContent = i;
                
                if(i === selectedDate.getDate() && navDate.getMonth() === selectedDate.getMonth() && navDate.getFullYear() === selectedDate.getFullYear()) 
                    dayEl.classList.add("selected");
                
                if(i === today.getDate() && navDate.getMonth() === today.getMonth() && navDate.getFullYear() === today.getFullYear()) 
                    dayEl.classList.add("today");
                
                dayEl.onclick = () => {
                    selectedDate = new Date(navDate.getFullYear(), navDate.getMonth(), i);
                    loadCalendar();
                    loadScheduleForDate(selectedDate);
                };
                calendarEl.appendChild(dayEl);
            }
        }

        function loadScheduleForDate(date) {
            const container = document.getElementById('time-slots');
            const title = document.getElementById('schedule-title');
            container.innerHTML = "";
            
            const today = new Date();
            today.setHours(0,0,0,0);
            const checkDate = new Date(date);
            checkDate.setHours(0,0,0,0);

            if(checkDate.getTime() < today.getTime()) {
                 title.textContent = `Hor√°rios passados de ${date.toLocaleDateString('pt-BR')}`;
                 container.innerHTML = '<p style="text-align:center; color:var(--cor-texto-claro); padding: 2rem;">N√£o √© poss√≠vel agendar em datas passadas.</p>';
                 return;
            }
            
            title.textContent = `Hor√°rios para ${date.toLocaleDateString('pt-BR')}`;
            const dateKey = formatDateKey(date);
            const bookings = roomsData[selectedRoomId]?.bookings?.[dateKey] || [];
            
            for(let hour=8; hour<18; hour++) {
                const now = new Date();
                if(checkDate.getTime() === today.getTime() && hour <= now.getHours()) continue;

                const booking = bookings.find(b => b.hour === hour);
                const slot = document.createElement('div');
                slot.className = 'time-slot';
                const timeString = `${String(hour).padStart(2,'0')}:00 - ${String(hour+1).padStart(2,'0')}:00`;

                if(booking) {
                    slot.style.background = "#fff1f2";
                    slot.style.borderColor = "var(--cor-primaria)";
                    slot.innerHTML = `
                        <div class="time-slot-header">
                            <span class="time-slot-time">${timeString}</span>
                            <span style="color:var(--cor-primaria); font-weight:600; font-size: 0.9rem;">Reservado</span>
                        </div>
                        <div style="font-size:0.9rem; margin-top:8px; color: var(--cor-texto);"><strong>${booking.title}</strong><br><span style="color: var(--cor-texto-claro);">Agendado por: ${booking.user}</span></div>
                    `;
                } else {
                    slot.innerHTML = `
                        <div class="time-slot-header">
                            <span class="time-slot-time">${timeString}</span>
                            <button class="btn btn-primary btn-reserve">Reservar hor√°rio</button>
                        </div>
                        <div class="booking-form">
                            <input class="form-input title" placeholder="Qual o assunto da reuni√£o?">
                            <input class="form-input user" placeholder="Seu nome completo">
                            <div class="form-actions">
                                <button class="btn btn-secondary btn-cancel">Cancelar</button>
                                <button class="btn btn-primary btn-confirm">Confirmar Agendamento</button>
                            </div>
                        </div>
                    `;
                    
                    const form = slot.querySelector('.booking-form');
                    const btnReserve = slot.querySelector('.btn-reserve');
                    
                    btnReserve.onclick = () => { form.style.display = 'flex'; btnReserve.style.display = 'none'; slot.querySelector('.title').focus(); };
                    slot.querySelector('.btn-cancel').onclick = () => { form.style.display = 'none'; btnReserve.style.display = 'block'; };
                    
                    slot.querySelector('.btn-confirm').onclick = async (e) => {
                        const titleVal = slot.querySelector('.title').value;
                        const userVal = slot.querySelector('.user').value;
                        if(!titleVal || !userVal) return showToast("Preencha o assunto e seu nome.", "error");
                        
                        const btn = e.target;
                        const originalText = btn.textContent;
                        btn.textContent = "Agendando...";
                        btn.disabled = true;
                        
                        try {
                            const roomRef = doc(db, "filiais", currentBranchId, "rooms", selectedRoomId);
                            await updateDoc(roomRef, {
                                [`bookings.${dateKey}`]: arrayUnion({ hour: hour, title: titleVal, user: userVal })
                            });
                            showToast("Sala reservada com sucesso!");
                        } catch(err) {
                            console.error(err);
                            showToast("Erro ao agendar.", "error");
                            btn.textContent = originalText;
                            btn.disabled = false;
                        }
                    };
                }
                container.appendChild(slot);
            }
            if(container.innerHTML === "") container.innerHTML = '<p style="text-align:center; color:var(--cor-texto-claro); padding: 2rem;">N√£o h√° mais hor√°rios dispon√≠veis.</p>';
        }

        function clearSchedule() {
            document.getElementById('time-slots').innerHTML = '<div style="text-align:center; color:var(--cor-texto-claro); padding: 3rem; display:flex; flex-direction:column; align-items:center; gap:1rem;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" style="opacity:0.5;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>Selecione um dia no calend√°rio para ver os hor√°rios.</div>';
        }

        const ADMIN_PASS = "AgendasAndra123"; 
        
        document.getElementById('admin-cancel-btn').onclick = () => {
            document.getElementById('password-modal').style.display = 'flex';
            document.getElementById('admin-password-input').focus();
        };

        document.querySelectorAll('.close-button-alt').forEach(b => {
             b.onclick = () => document.querySelector(b.dataset.target).style.display = 'none';
        });
        
        document.getElementById('password-submit-btn').onclick = checkPassword;
        document.getElementById('admin-password-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') checkPassword(); });

        function checkPassword() {
            const input = document.getElementById('admin-password-input');
            if(input.value === ADMIN_PASS) {
                document.getElementById('password-modal').style.display = 'none';
                input.value = "";
                openAdminPanel();
            } else {
                showToast("Senha incorreta.", "error");
                input.value = "";
                input.focus();
            }
        };

        function openAdminPanel() {
            const list = document.getElementById('admin-cancel-list');
            list.innerHTML = "";
            const today = new Date(); today.setHours(0,0,0,0);
            let found = false;
            
            Object.keys(roomsData).forEach(roomId => {
                const room = roomsData[roomId];
                if(!room.bookings) return;
                
                Object.keys(room.bookings).forEach(dateKey => {
                    const [y, m, d] = dateKey.split('-').map(Number);
                    const bDate = new Date(y, m-1, d);
                    
                    if(bDate >= today) {
                        room.bookings[dateKey].forEach(booking => {
                            const now = new Date();
                            if(bDate.getTime() > today.getTime() || (bDate.getTime() === today.getTime() && booking.hour > now.getHours())) {
                                found = true;
                                const item = document.createElement('div');
                                item.className = 'admin-booking-item';
                                item.innerHTML = `
                                    <div class="admin-booking-info">
                                        <strong>${room.name}</strong>
                                        <div class="admin-booking-details">üìÖ ${d}/${m}/${y} √†s ${booking.hour}:00h</div>
                                        <div class="admin-booking-details">üë§ ${booking.title} (${booking.user})</div>
                                    </div>
                                    <button class="btn btn-danger">Cancelar</button>
                                `;
                                
                                const cancelBtn = item.querySelector('button');
                                cancelBtn.onclick = async function() {
                                    if(cancelBtn.textContent !== "Confirmar?") {
                                        cancelBtn.textContent = "Confirmar?";
                                        setTimeout(() => cancelBtn.textContent = "Cancelar", 3000);
                                        return;
                                    }
                                    
                                    cancelBtn.textContent = "...";
                                    cancelBtn.disabled = true;
                                    try {
                                        const roomRef = doc(db, "filiais", currentBranchId, "rooms", roomId);
                                        await updateDoc(roomRef, { [`bookings.${dateKey}`]: arrayRemove(booking) });
                                        showToast("Reserva cancelada.");
                                        item.remove();
                                        if(list.children.length === 0) list.innerHTML = "<p style='text-align:center; color:var(--cor-texto-claro);'>Nenhum agendamento futuro encontrado.</p>";
                                    } catch(e) { showToast("Erro ao cancelar", "error"); cancelBtn.textContent = "Cancelar"; cancelBtn.disabled = false;}
                                };
                                list.appendChild(item);
                            }
                        });
                    }
                });
            });
            
            if(!found) list.innerHTML = "<p style='text-align:center; color:var(--cor-texto-claro); padding: 2rem;'>Nenhum agendamento futuro encontrado nesta unidade.</p>";
            document.getElementById('admin-cancel-modal').style.display = 'flex';
        }

        document.getElementById('prev-month-btn').onclick = () => { selectedDate.setMonth(selectedDate.getMonth()-1); loadCalendar(); };
        document.getElementById('next-month-btn').onclick = () => { selectedDate.setMonth(selectedDate.getMonth()+1); loadCalendar(); };

        document.querySelectorAll('.close-button').forEach(b => {
            b.onclick = () => document.querySelector(b.dataset.target).style.display = 'none';
        });
        
        window.onclick = (event) => {
            if (event.target.classList.contains('modal')) event.target.style.display = 'none';
        };

        // --- L√ìGICA DO BOT√ÉO "VER AGENDA DO DIA" ---
    document.getElementById('general-calendar-btn').addEventListener('click', () => {
        const list = document.getElementById('general-schedule-list');
        list.innerHTML = "";
        
        const now = new Date();
        const dateKey = formatDateKey(now);
        let allBookings = [];

        // 1. Coleta todas as reuni√µes de hoje de todas as salas
        Object.values(roomsData).forEach(room => {
            if (room.bookings && room.bookings[dateKey]) {
                room.bookings[dateKey].forEach(booking => {
                    allBookings.push({
                        ...booking,
                        roomName: room.name
                    });
                });
            }
        });

        // 2. Ordena por hor√°rio (do mais cedo para o mais tarde)
        allBookings.sort((a, b) => a.hour - b.hour);

        // 3. Exibe na tela
        if (allBookings.length === 0) {
            list.innerHTML = '<div style="text-align:center; padding: 3rem; color: var(--cor-texto-claro);"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" style="opacity:0.3; margin-bottom:1rem;"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg><br>Nenhuma reuni√£o agendada para hoje nesta unidade.</div>';
        } else {
            allBookings.forEach(b => {
                const item = document.createElement('div');
                // Reutilizando o estilo elegante dos cards de lista
                item.className = 'admin-booking-item'; 
                item.style.cursor = 'default';
                item.innerHTML = `
                    <div class="admin-booking-info" style="width: 100%;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                            <strong style="font-size:1.2rem; color:var(--cor-primaria);">${b.hour}:00 - ${b.hour+1}:00</strong>
                            <span style="background:#f1f5f9; padding:2px 8px; border-radius:4px; font-size:0.8rem; font-weight:600; color:var(--cor-texto-claro);">${b.roomName}</span>
                        </div>
                        <div style="font-weight:600; font-size:1rem;">${b.title}</div>
                        <div class="admin-booking-details">Respons√°vel: ${b.user}</div>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        document.getElementById('general-calendar-modal').style.display = 'flex';
    });

        // Inicia
        loadBranches();
    </script>
</body>
</html>
